function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}();!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("lodash"),require("jwt-decode"),require("superagent")):"function"==typeof define&&define.amd?define(["lodash","jwt-decode","superagent"],r):e.Matter=r(e._,e.jwtDecode,e.superagent)}(this,function(e,r,t){"use strict";function n(e,r){return e&&console[e]?console[e].apply(console,r):console.log.apply(console,r)}function o(e){var r="",t={};u.isObject(e)?("debug"==g&&u.has(e,"func")&&(r+=u.has(e,"obj")?"["+e.obj+"."+e.func+"()]\n ":u.has(e,"file")?"["+e.file+" > "+e.func+"()]\n ":"["+e.func+"()]\n "),u.each(u.omit(u.keys(e)),function(n,o,i){"func"!=n&&"obj"!=n&&("description"==n||"message"==n?r+=e[n]:u.isString(e[n])?t[n]=e[n]:t[n]=e[n])}),r+="\n"):u.isString(e)&&(r=e);var n=[r,t];return n}function i(e){var t=void 0;if(e&&""!=e)try{t=r(e)}catch(n){throw h.error({description:"Error decoding token.",data:t,error:n,func:"decodeToken",file:"token"}),new Error("Invalid token string.")}return t}function s(e){return new Promise(function(r,t){e.end(function(e,n){return e?(401==e.status&&h.warn({description:"Unauthorized. You must be signed into make this request.",func:"handleResponse"}),e&&e.response?t(e.response.text):(h.warn({description:"Unauthorized. You must be signed into make this request.",error:e,func:"handleResponse"}),t(e))):r(n.body)})})}function a(e){return j.string&&(e=e.set("Authorization","Bearer "+j.string),console.info({message:"Set auth header",func:"addAuthHeader",file:"request"})),e}var u="default"in e?e["default"]:e;r="default"in r?r["default"]:r,t="default"in t?t["default"]:t;var c={envs:{local:{serverUrl:"http://localhost:4000",logLevel:"trace"},dev:{serverUrl:"http://tessellate-stage.elasticbeanstalk.com",logLevel:"debug"},stage:{serverUrl:"http://tessellate-stage.elasticbeanstalk.com",logLevel:"info"},prod:{serverUrl:"http://tessellate.elasticbeanstalk.com",logLevel:"warn"}},tokenName:"tessellate",tokenDataName:"tessellate-tokenData",tokenUserDataName:"tessellate-currentUser"},d=null,l="prod",p=function(){function r(){return _classCallCheck(this,r),d||(d=this),e.merge(d,c)}return _createClass(r,[{key:"applySettings",value:function(r){e.merge(d,r)}},{key:"serverUrl",get:function(){var r=c.envs[l].serverUrl;return"undefined"!=typeof window&&e.has(window,"location")&&window.location.host===r&&(r=""),r}},{key:"logLevel",get:function(){return c.envs[l].logLevel}},{key:"envName",set:function(e){l=e}},{key:"env",get:function(){return c.envs[l]}}]),r}(),f=new p,g="debug",h={log:function(e){var r=o(e);"production"==f.envName?n("log",r):n("log",r)},info:function(e){var r=o(e);"production"==f.envName?n("info",r):n("info",r)},warn:function(e){var r=o(e);"production"==f.envName?n("warn",r):n("warn",r)},debug:function(e){var r=o(e);"production"==f.envName||n("debug",r)},error:function(e){var r=o(e);"production"==f.envName?n("error",r):n("error",r)}},m={loadCss:function(e){if("undefined"==typeof document)throw h.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.");var r=document.createElement("link");return r.rel="stylesheet",r.type="text/css",r.href=e,document.getElementsByTagName("head")[0].insertBefore(r,document.getElementsByTagName("head")[0].firstChild),h.log({description:"CSS was loaded into document.",element:r,func:"loadCss",obj:"dom"}),r},loadJs:function(e){if("undefined"!=typeof window&&u.has(window,"document")){var r=window.document.createElement("script");return r.src=e,r.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(r),h.log({description:"JS was loaded into document.",element:r,func:"loadCss",obj:"dom"}),r}throw h.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")},asyncLoadJs:function(e){if("undefined"!=typeof window&&u.has(window,"document")){var r=window.document.createElement("script");return r.src=e,r.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(r),h.log({description:"JS was loaded into document.",element:r,func:"loadCss",obj:"dom"}),new Promise(function(e,r){window.setTimeout(e,30)})}throw h.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")}},v={},w=Object.defineProperties({item:function(e,r){return this.setItem(e,r)},setItem:function(e,r){v[e]=r,this.localExists&&(u.isObject(r)&&(r=JSON.stringify(r)),window.sessionStorage.setItem(e,r))},getItem:function(e){if(v[e])return v[e];if(this.localExists){var r=window.sessionStorage.getItem(e);if(r){var t=!1,n=null;try{n=JSON.parse(r),t=!0}catch(o){t=!1}if(t)return n}return r}return null},removeItem:function(e){if(v[e]&&(v[e]=null),this.localExists)try{window.sessionStorage.removeItem(e)}catch(r){h.error({description:"Error removing item from session storage",error:r,obj:"storage",func:"removeItem"})}},clear:function(){if(v={},this.localExists)try{window.sessionStorage.clear()}catch(e){h.warn({description:"Session storage could not be cleared.",error:e})}}},{localExists:{get:function(){var e="test";if("undefined"==typeof window||"undefined"==typeof window.sessionStorage)return!1;try{return window.sessionStorage.setItem(e,"1"),window.sessionStorage.removeItem(e),!0}catch(r){return h.error({description:"Error saving to session storage",error:r,obj:"storage",func:"localExists"}),!1}},configurable:!0,enumerable:!0}}),j=Object.defineProperties({save:function(e){this.string=e},"delete":function(){w.removeItem(f.tokenName),w.removeItem(f.tokenDataName),h.log({description:"Token was removed.",func:"delete",obj:"token"})}},{string:{get:function(){return w.getItem(f.tokenName)},set:function(e){var t=void 0;if(u.isString(e))t=e;else{if(h.log({description:"Token data is not string.",token:e,func:"string",obj:"token"}),!u.isObject(e)||!u.has(e,"token"))return void h.error({description:"Invalid value set to token.",token:e,func:"string",obj:"token"});t=e.token}h.log({description:"Token was set.",token:e,tokenStr:t,func:"string",obj:"token"}),w.setItem(f.tokenName,t),this.data=r(t)},configurable:!0,enumerable:!0},data:{get:function(){return w.getItem(f.tokenDataName)?w.getItem(f.tokenDataName):i(this.string)},set:function(e){if(u.isString(e)){var r=e;e=i(r),h.info({description:"Token data was set as string. Decoding token.",token:r,tokenData:e,func:"data",obj:"token"})}else h.log({description:"Token data was set.",data:e,func:"data",obj:"token"}),w.setItem(f.tokenDataName,e)},configurable:!0,enumerable:!0}}),b={get:function(e,r){var n=t.get(e);return r&&n.query(r),n=a(n),s(n)},post:function(e,r){var n=t.post(e).send(r);return n=a(n),s(n)},put:function(e,r){var n=t.put(e,r);return n=a(n),s(n)},del:function(e,r){var n=t.put(e,r);return n=a(n),s(n)}},k={},y=function(){function e(r){_classCallCheck(this,e),this.app=r.app?r.app:null,this.redirectUri=r.redirectUri?r.redirectUri:"redirect.html",this.provider=r.provider?r.provider:null}return _createClass(e,[{key:"loadHello",value:function(){return"undefined"==typeof window||window.hello?Promise.reject():m.asyncLoadJs("https://s3.amazonaws.com/kyper-cdn/js/hello.js")}},{key:"helloLoginListener",value:function(){window.hello.on("auth.login",function(e){h.info({description:"User logged in to google.",func:"loadHello",obj:"Google"}),window.hello(e.network).api("/me").then(function(r){var t=r;return t.provider=e.network,b.post(this.endpoint+"/provider",t).then(function(e){return h.log({description:"Provider request successful.",response:e,func:"signup",obj:"GoogleUtil"}),e})["catch"](function(e){return h.error({description:"Error requesting login.",error:e,func:"signup",obj:"Matter"}),Promise.reject(e)})})})}},{key:"initHello",value:function(){var e=this;return this.loadHello().then(function(){return b.get(e.app.endpoint+"/providers").then(function(r){h.log({description:"Provider request successful.",response:r,func:"initHello",obj:"ProviderAuth"});var t=r[e.provider];return t?(h.log({description:"Providers config built",providersConfig:r,func:"initHello",obj:"ProviderAuth"}),window.hello.init(r,{redirect_uri:"redirect.html"})):(h.error({description:"Provider is not setup. Visit tessellate.kyper.io to enter your client id for "+e.provider,provider:e.provider,clientIds:k,func:"login",obj:"ProviderAuth"}),Promise.reject({message:"Provider is not setup."}))},function(e){return h.error({description:"Error loading hellojs.",error:errRes,func:"initHello",obj:"ProviderAuth"}),Promise.reject({message:"Error requesting application third party providers."})})["catch"](function(e){return h.error({description:"Error loading hellojs.",error:e,func:"initHello",obj:"ProviderAuth"}),Promise.reject({message:"Error loading third party login capability."})})})}},{key:"login",value:function(){var e=this;return this.initHello().then(function(){return window.hello.login(e.provider)},function(e){return h.error({description:"Error initalizing hellojs.",error:e,func:"login",obj:"Matter"}),Promise.reject({message:"Error with third party login."})})}},{key:"signup",value:function(){return this.login()}}]),e}(),P=function(){function e(r,t){if(_classCallCheck(this,e),!r)throw h.error({description:"Application name requires to use Matter.",func:"constructor",obj:"Matter"}),new Error("Application name is required to use Matter");this.name=r,t&&(this.options=t),this.config=f}return _createClass(e,[{key:"signup",value:function(e){if(h.log({description:"Signup called.",signupData:e,func:"signup",obj:"Matter"}),!e||!u.isObject(e)&&!u.isString(e))return h.error({description:"Signup information is required to signup.",func:"signup",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(u.isObject(e))return b.post(this.endpoint+"/signup",e).then(function(r){return h.log({description:"Account request successful.",signupData:e,response:r,func:"signup",obj:"Matter"}),u.has(r,"account")?r.account:(h.warn({description:"Account was not contained in signup response.",signupData:e,response:r,func:"signup",obj:"Matter"}),r)})["catch"](function(r){return h.error({description:"Error requesting signup.",signupData:e,error:r,func:"signup",obj:"Matter"}),Promise.reject(r)});var r=new y({provider:e,app:this});return r.signup(e).then(function(r){return h.info({description:"Provider signup successful.",provider:e,res:r,func:"signup",obj:"Matter"}),Promise.resolve(r)})}},{key:"login",value:function(e){var r=this;if(!e||!u.isObject(e)&&!u.isString(e))return h.error({description:"Username/Email and Password are required to login",func:"login",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(u.isObject(e))return e.password&&e.username?b.put(this.endpoint+"/login",e).then(function(e){return u.has(e,"data")&&u.has(e.data,"status")&&409==e.data.status?(h.warn({description:"Account not found.",response:e,func:"login",obj:"Matter"}),Promise.reject(e.data)):(h.log({description:"Successful login.",response:e,func:"login",obj:"Matter"}),u.has(e,"token")&&(r.token.string=e.token),u.has(e,"account")&&r.storage.setItem(f.tokenUserDataName,e.account),e.account)})["catch"](function(e){return h.error({description:"Error requesting login.",error:e,status:e.status,func:"login",obj:"Matter"}),(409==e.status||400==e.status)&&(e=e.response.text),Promise.reject(e)}):Promise.reject({message:"Username/Email and Password are required to login"});var t=new y({provider:e,app:this});return t.login().then(function(r){return h.info({description:"Provider login successful.",provider:e,res:r,func:"login",obj:"Matter"}),Promise.resolve(r)})}},{key:"logout",value:function(){var e=this;return this.isLoggedIn?b.put(this.endpoint+"/logout").then(function(r){return h.log({description:"Logout successful.",response:r,func:"logout",obj:"Matter"}),e.currentUser=null,e.token["delete"](),r})["catch"](function(r){return h.error({description:"Error requesting log out: ",error:r,func:"logout",obj:"Matter"}),e.storage.removeItem(f.tokenUserDataName),e.token["delete"](),Promise.reject(r)}):(h.warn({description:"No logged in account to log out.",func:"logout",obj:"Matter"}),Promise.reject({message:"No logged in account to log out."}))}},{key:"getCurrentUser",value:function(){var e=this;return this.currentUser?Promise.resolve(this.currentUser):this.isLoggedIn?b.get(this.endpoint+"/user").then(function(r){return h.log({description:"Current User Request responded.",responseData:r,func:"currentUser",obj:"Matter"}),e.currentUser=r,r})["catch"](function(e){return 401==e.status?(h.warn({description:"Called for current user without token.",error:e,func:"currentUser",obj:"Matter"}),j["delete"](),Promise.resolve(null)):(h.error({description:"Error requesting current user.",error:e,func:"currentUser",obj:"Matter"}),Promise.reject(e))}):Promise.resolve(null)}},{key:"updateProfile",value:function(e){var r=this;return this.isLoggedIn?b.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return h.log({description:"Update profile request responded.",responseData:e,func:"updateProfile",obj:"Matter"}),r.currentUser=e,e})["catch"](function(e){return h.error({description:"Error requesting current user.",error:e,func:"updateProfile",obj:"Matter"}),Promise.reject(e)}):(h.error({description:"No current user profile to update.",func:"updateProfile",obj:"Matter"}),Promise.reject({message:"Must be logged in to update profile."}))}},{key:"changePassword",value:function(e){return this.isLoggedIn?b.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return h.log({description:"Update password request responded.",responseData:e,func:"changePassword",obj:"Matter"}),e})["catch"](function(e){return h.error({description:"Error requesting password change.",error:e,func:"changePassword",obj:"Matter"}),Promise.reject(e)}):(h.error({description:"No current user profile for which to change password.",func:"changePassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to change password."}))}},{key:"recoverPassword",value:function(){return this.isLoggedIn?b.post(this.endpoint+"/accounts/"+this.token.data.username+"/recover").then(function(e){return h.log({description:"Recover password request responded.",responseData:e,func:"recoverPassword",obj:"Matter"}),e})["catch"](function(e){return h.error({description:"Error requesting password recovery.",error:e,func:"recoverPassword",obj:"Matter"}),Promise.reject(e)}):(h.error({description:"No current user for which to recover password.",func:"recoverPassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to recover password."}))}},{key:"isInGroup",value:function(e){var r=this;if(!this.isLoggedIn)return h.log({description:"No logged in user to check.",func:"isInGroup",obj:"Matter"}),!1;if(!e||!u.isString(e))return e&&u.isArray(e)?(h.info({description:"Array of groups.",list:e,func:"isInGroup",obj:"Matter"}),this.isInGroups(e)):!1;var t=function(){var t=e,n=t.split(",");if(n.length>1)return h.info({description:"String list of groups.",list:n,func:"isInGroup",obj:"Matter"}),{v:r.isInGroups(n)};var o=r.token.data.groups||[];return h.log({description:"Checking if user is in group.",group:t,userGroups:r.token.data.groups||[],func:"isInGroup",obj:"Matter"}),{v:u.any(o,function(e){return t==e.name})}}();return"object"==typeof t?t.v:void 0}},{key:"isInGroups",value:function(e){var r=this;if(!this.isLoggedIn)return h.log({description:"No logged in user to check.",func:"isInGroups",obj:"Matter"}),!1;if(e&&u.isArray(e))return u.every(u.map(e,function(e){return u.isString(e)?r.isInGroup(e):u.has(e,"name")?r.isInGroup(e.name):(h.error({description:"Invalid group object.",group:e,func:"isInGroups",obj:"Matter"}),!1)}),!0);if(e&&u.isString(e)){var t=e.split(",");return t.length>1?this.isInGroups(t):this.isInGroup(t[0])}return h.error({description:"Invalid groups list.",func:"isInGroups",obj:"Matter"}),!1}},{key:"endpoint",get:function(){u.has(this,"options")&&(this.options.localServer&&(f.envName="local",h.info({description:"LocalServer option was set to true. Now server url is local server.",url:f.serverUrl,func:"endpoint",obj:"Matter"})),this.options.env&&(f.envName=this.options.env,h.info({description:"Environment set based on provided environment.",config:f,func:"endpoint",obj:"Matter"})));var e=f.serverUrl+"/apps/"+this.name;return"tessellate"==this.name&&("undefined"==typeof window||!u.has(window,"location")||-1===window.location.host.indexOf("tessellate")&&-1===window.location.host.indexOf("localhost")||(e=serverUrl,h.info({description:"Host is Tessellate Server, serverUrl simplified!",url:serverUrl,func:"endpoint",obj:"Matter"}))),h.log({description:"Endpoint created.",url:e,func:"endpoint",obj:"Matter"}),e}},{key:"isLoggedIn",get:function(){return this.token.string?!0:!1}},{key:"currentUser",set:function(e){h.log({description:"Current User set.",user:e,func:"currentUser",obj:"Matter"}),this.storage.setItem(f.tokenUserDataName,e)},get:function(){return this.storage.getItem(f.tokenUserDataName)?this.storage.getItem(f.tokenUserDataName):null}},{key:"storage",get:function(){return w}},{key:"token",get:function(){return j}},{key:"utils",get:function(){return{logger:h,request:b,storage:w,dom:m}}}]),e}();return P});
//# sourceMappingURL=matter.min.js.map
