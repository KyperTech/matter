function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}();!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("lodash"),require("superagent"),require("jwt-decode")):"function"==typeof define&&define.amd?define(["lodash","superagent","jwt-decode"],t):e.Matter=t(e._,e.superagent,e.jwtDecode)}(this,function(e,t,r){"use strict";function n(e,t){return e&&console[e]?console[e].apply(console,t):console.log.apply(console,t)}function o(e){var t="",r={};u.isObject(e)?("debug"==g&&u.has(e,"func")&&(t+=u.has(e,"obj")?"["+e.obj+"."+e.func+"()]\n ":u.has(e,"file")?"["+e.file+" > "+e.func+"()]\n ":"["+e.func+"()]\n "),u.each(u.omit(u.keys(e)),function(n){"func"!=n&&"obj"!=n&&("description"==n||"message"==n?t+=e[n]:u.isString(e[n])?r[n]=e[n]:r[n]=e[n])}),t+="\n"):u.isString(e)&&(t=e);var n=[t,r];return n}function i(e){var t=void 0;if(e&&""!=e)try{t=r(e)}catch(n){throw h.error({description:"Error decoding token.",data:t,error:n,func:"decodeToken",file:"token"}),new Error("Invalid token string.")}return t}function s(e){return new Promise(function(t,r){e.end(function(e,n){return e?(401==e.status&&h.warn({description:"Unauthorized. You must be signed into make this request.",func:"handleResponse"}),e&&e.response?r(e.response.text):(h.warn({description:"Unauthorized. You must be signed into make this request.",error:e,func:"handleResponse"}),r(e))):t(n.body)})})}function a(e){return b.string&&(e=e.set("Authorization","Bearer "+b.string)),e}var u="default"in e?e["default"]:e;t="default"in t?t["default"]:t,r="default"in r?r["default"]:r;var c={envs:{local:{serverUrl:"http://localhost:4000",logLevel:"trace"},dev:{serverUrl:"http://tessellate-stage.elasticbeanstalk.com",logLevel:"debug"},stage:{serverUrl:"http://tessellate-stage.elasticbeanstalk.com",logLevel:"info"},prod:{serverUrl:"http://tessellate.elasticbeanstalk.com",logLevel:"warn"}},tokenName:"tessellate",tokenDataName:"tessellate-tokenData",tokenUserDataName:"tessellate-currentUser"},d=null,l="prod",f=function(){function t(){return _classCallCheck(this,t),d||(d=this),e.merge(d,c)}return _createClass(t,[{key:"applySettings",value:function(t){e.merge(d,t)}},{key:"serverUrl",get:function(){var t=c.envs[l].serverUrl;return"undefined"!=typeof window&&e.has(window,"location")&&window.location.host===t&&(t=""),t}},{key:"logLevel",get:function(){return c.envs[l].logLevel}},{key:"envName",set:function(e){l=e}},{key:"env",get:function(){return c.envs[l]}}]),t}(),p=new f,g="debug",h={log:function(e){var t=o(e);"production"==p.envName?n("log",t):n("log",t)},info:function(e){var t=o(e);"production"==p.envName?n("info",t):n("info",t)},warn:function(e){var t=o(e);"production"==p.envName?n("warn",t):n("warn",t)},debug:function(e){var t=o(e);"production"==p.envName||n("debug",t)},error:function(e){var t=o(e);"production"==p.envName?n("error",t):n("error",t)}},m={loadCss:function(e){if("undefined"==typeof document)throw h.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.");var t=document.createElement("link");return t.rel="stylesheet",t.type="text/css",t.href=e,document.getElementsByTagName("head")[0].insertBefore(t,document.getElementsByTagName("head")[0].firstChild),h.log({description:"CSS was loaded into document.",element:t,func:"loadCss",obj:"dom"}),t},loadJs:function(e){if("undefined"!=typeof window&&u.has(window,"document")){var t=window.document.createElement("script");return t.src=e,t.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(t),h.log({description:"JS was loaded into document.",element:t,func:"loadCss",obj:"dom"}),t}throw h.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")},asyncLoadJs:function(e){if("undefined"!=typeof window&&u.has(window,"document")){var t=window.document.createElement("script");return t.src=e,t.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(t),h.log({description:"JS was loaded into document.",element:t,func:"loadCss",obj:"dom"}),new Promise(function(e){window.setTimeout(e,30)})}throw h.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")}},v={},w=Object.defineProperties({item:function(e,t){return this.setItem(e,t)},setItem:function(e,t){v[e]=t,this.localExists&&(u.isObject(t)&&(t=JSON.stringify(t)),window.sessionStorage.setItem(e,t))},getItem:function(e){if(v[e])return v[e];if(this.localExists){var t=window.sessionStorage.getItem(e);if(t){var r=!1,n=null;try{n=JSON.parse(t),r=!0}catch(o){r=!1}if(r)return n}return t}return null},removeItem:function(e){if(v[e]&&(v[e]=null),this.localExists)try{window.sessionStorage.removeItem(e)}catch(t){h.error({description:"Error removing item from session storage",error:t,obj:"storage",func:"removeItem"})}},clear:function(){if(v={},this.localExists)try{window.sessionStorage.clear()}catch(e){h.warn({description:"Session storage could not be cleared.",error:e})}}},{localExists:{get:function(){var e="test";if("undefined"==typeof window||"undefined"==typeof window.sessionStorage)return!1;try{return window.sessionStorage.setItem(e,"1"),window.sessionStorage.removeItem(e),!0}catch(t){return h.error({description:"Error saving to session storage",error:t,obj:"storage",func:"localExists"}),!1}},configurable:!0,enumerable:!0}}),b=Object.defineProperties({save:function(e){this.string=e},"delete":function(){w.removeItem(p.tokenName),w.removeItem(p.tokenDataName),h.log({description:"Token was removed.",func:"delete",obj:"token"})}},{string:{get:function(){return w.getItem(p.tokenName)},set:function(e){var t=void 0;if(u.isString(e))t=e;else{if(h.log({description:"Token data is not string.",token:e,func:"string",obj:"token"}),!u.isObject(e)||!u.has(e,"token"))return void h.error({description:"Invalid value set to token.",token:e,func:"string",obj:"token"});t=e.token}h.log({description:"Token was set.",token:e,tokenStr:t,func:"string",obj:"token"}),w.setItem(p.tokenName,t),this.data=r(t)},configurable:!0,enumerable:!0},data:{get:function(){return w.getItem(p.tokenDataName)?w.getItem(p.tokenDataName):i(this.string)},set:function(e){if(u.isString(e)){var t=e;e=i(t),h.info({description:"Token data was set as string. Decoding token.",token:t,tokenData:e,func:"data",obj:"token"})}else h.log({description:"Token data was set.",data:e,func:"data",obj:"token"}),w.setItem(p.tokenDataName,e)},configurable:!0,enumerable:!0}}),j={get:function(e,r){var n=t.get(e);return r&&n.query(r),n=a(n),s(n)},post:function(e,r){var n=t.post(e).send(r);return n=a(n),s(n)},put:function(e,r){var n=t.put(e,r);return n=a(n),s(n)},del:function(e,r){var n=t.put(e,r);return n=a(n),s(n)}},k={},y=function(){function e(t){_classCallCheck(this,e),this.app=t.app?t.app:null,this.redirectUri=t.redirectUri?t.redirectUri:"redirect.html",this.provider=t.provider?t.provider:null}return _createClass(e,[{key:"loadHello",value:function(){return"undefined"==typeof window||window.hello?Promise.reject():m.asyncLoadJs("https://s3.amazonaws.com/kyper-cdn/js/hello.js")}},{key:"helloLoginListener",value:function(){window.hello.on("auth.login",function(e){h.info({description:"User logged in to google.",func:"loadHello",obj:"Google"}),window.hello(e.network).api("/me").then(function(t){var r=t;return r.provider=e.network,j.post(this.endpoint+"/provider",r).then(function(e){return h.log({description:"Provider request successful.",response:e,func:"signup",obj:"GoogleUtil"}),e})["catch"](function(e){return h.error({description:"Error requesting login.",error:e,func:"signup",obj:"Matter"}),Promise.reject(e)})})})}},{key:"initHello",value:function(){var e=this;return this.loadHello().then(function(){return j.get(e.app.endpoint+"/providers").then(function(t){h.log({description:"Provider request successful.",response:t,func:"initHello",obj:"ProviderAuth"});var r=t[e.provider];return r?(h.log({description:"Providers config built",providersConfig:t,func:"initHello",obj:"ProviderAuth"}),window.hello.init(t,{redirect_uri:"redirect.html"})):(h.error({description:"Provider is not setup.\nVisit build.kyper.io to enter your client id for "+e.provider,provider:e.provider,clientIds:k,func:"login",obj:"ProviderAuth"}),Promise.reject({message:"Provider is not setup."}))},function(e){return h.error({description:"Error loading hellojs.",error:e,func:"initHello",obj:"ProviderAuth"}),Promise.reject({message:"Error requesting application third party providers."})})["catch"](function(e){return h.error({description:"Error loading hellojs.",error:e,func:"initHello",obj:"ProviderAuth"}),Promise.reject({message:"Error loading third party login capability."})})})}},{key:"login",value:function(){var e=this;return this.initHello().then(function(){return window.hello.login(e.provider)},function(e){return h.error({description:"Error initalizing hellojs.",error:e,func:"login",obj:"Matter"}),Promise.reject({message:"Error with third party login."})})}},{key:"signup",value:function(){return this.login()}}]),e}(),P=function(){function e(t,r){if(_classCallCheck(this,e),!t)throw h.error({description:"Application name requires to use Matter.",func:"constructor",obj:"Matter"}),new Error("Application name is required to use Matter");this.name=t,r&&(this.options=r),this.config=p}return _createClass(e,[{key:"signup",value:function(e){if(h.log({description:"Signup called.",signupData:e,func:"signup",obj:"Matter"}),!e||!u.isObject(e)&&!u.isString(e))return h.error({description:"Signup information is required to signup.",func:"signup",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(u.isObject(e))return j.post(this.endpoint+"/signup",e).then(function(t){return h.log({description:"Account request successful.",signupData:e,response:t,func:"signup",obj:"Matter"}),u.has(t,"account")?t.account:(h.warn({description:"Account was not contained in signup response.",signupData:e,response:t,func:"signup",obj:"Matter"}),t)})["catch"](function(t){return h.error({description:"Error requesting signup.",signupData:e,error:t,func:"signup",obj:"Matter"}),Promise.reject(t)});var t=new y({provider:e,app:this});return t.signup(e).then(function(t){return h.info({description:"Provider signup successful.",provider:e,res:t,func:"signup",obj:"Matter"}),Promise.resolve(t)})}},{key:"login",value:function(e){var t=this;if(!e||!u.isObject(e)&&!u.isString(e))return h.error({description:"Username/Email and Password are required to login",func:"login",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(u.isObject(e))return e.password&&e.username?j.put(this.endpoint+"/login",e).then(function(e){if(u.has(e,"data")&&u.has(e.data,"status")&&409==e.data.status)return h.warn({description:"Account not found.",response:e,func:"login",obj:"Matter"}),Promise.reject(e.data);h.log({description:"Successful login.",response:e,func:"login",obj:"Matter"}),u.has(e,"token")&&(t.token.string=e.token);var r={};return u.has(e,"account")?r=e.account:t.token.data?(h.log({description:"User data available from token.",tokenData:t.token.data,type:typeof t.token.data,func:"login",obj:"Matter"}),t.token.data.un?(h.log({description:"Token is AuthRocket format.",func:"login",obj:"Matter"}),r={username:t.token.data.un,name:t.token.data.n||null,authrocketId:t.token.data.uid||null}):(h.log({description:"Token is default format.",func:"login",obj:"Matter"}),r=t.token.data)):(h.error({description:"User data not available from response or token.",func:"login",obj:"Matter"}),r={token:t.token.string}),t.storage.setItem(p.tokenUserDataName,r),r})["catch"](function(e){return h.error({description:"Error requesting login.",error:e,status:e.status,func:"login",obj:"Matter"}),(409==e.status||400==e.status)&&(e=e.response.text),Promise.reject(e)}):Promise.reject({message:"Username/Email and Password are required to login"});var r=new y({provider:e,app:this});return r.login().then(function(t){return h.info({description:"Provider login successful.",provider:e,res:t,func:"login",obj:"Matter"}),Promise.resolve(t)})}},{key:"logout",value:function(){var e=this;return this.isLoggedIn?j.put(this.endpoint+"/logout").then(function(t){return h.log({description:"Logout successful.",response:t,func:"logout",obj:"Matter"}),e.currentUser=null,e.token["delete"](),t})["catch"](function(t){return h.error({description:"Error requesting log out: ",error:t,func:"logout",obj:"Matter"}),e.storage.removeItem(p.tokenUserDataName),e.token["delete"](),Promise.reject(t)}):(h.warn({description:"No logged in account to log out.",func:"logout",obj:"Matter"}),Promise.reject({message:"No logged in account to log out."}))}},{key:"getCurrentUser",value:function(){var e=this;return this.currentUser?Promise.resolve(this.currentUser):this.isLoggedIn?j.get(this.endpoint+"/user").then(function(t){return h.log({description:"Current User Request responded.",responseData:t,func:"currentUser",obj:"Matter"}),e.currentUser=t,t})["catch"](function(e){return 401==e.status?(h.warn({description:"Called for current user without token.",error:e,func:"currentUser",obj:"Matter"}),b["delete"](),Promise.resolve(null)):(h.error({description:"Error requesting current user.",error:e,func:"currentUser",obj:"Matter"}),Promise.reject(e))}):Promise.resolve(null)}},{key:"updateProfile",value:function(e){var t=this;return this.isLoggedIn?j.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return h.log({description:"Update profile request responded.",responseData:e,func:"updateProfile",obj:"Matter"}),t.currentUser=e,e})["catch"](function(e){return h.error({description:"Error requesting current user.",error:e,func:"updateProfile",obj:"Matter"}),Promise.reject(e)}):(h.error({description:"No current user profile to update.",func:"updateProfile",obj:"Matter"}),Promise.reject({message:"Must be logged in to update profile."}))}},{key:"changePassword",value:function(e){return this.isLoggedIn?j.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return h.log({description:"Update password request responded.",responseData:e,func:"changePassword",obj:"Matter"}),e})["catch"](function(e){return h.error({description:"Error requesting password change.",error:e,func:"changePassword",obj:"Matter"}),Promise.reject(e)}):(h.error({description:"No current user profile for which to change password.",func:"changePassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to change password."}))}},{key:"recoverPassword",value:function(){return this.isLoggedIn?j.post(this.endpoint+"/accounts/"+this.token.data.username+"/recover").then(function(e){return h.log({description:"Recover password request responded.",responseData:e,func:"recoverPassword",obj:"Matter"}),e})["catch"](function(e){return h.error({description:"Error requesting password recovery.",error:e,func:"recoverPassword",obj:"Matter"}),Promise.reject(e)}):(h.error({description:"No current user for which to recover password.",func:"recoverPassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to recover password."}))}},{key:"isInGroup",value:function(e){var t=this;if(!this.isLoggedIn)return h.log({description:"No logged in user to check.",func:"isInGroup",obj:"Matter"}),!1;if(!e||!u.isString(e))return e&&u.isArray(e)?(h.info({description:"Array of groups.",list:e,func:"isInGroup",obj:"Matter"}),this.isInGroups(e)):!1;var r=function(){var r=e,n=r.split(",");if(n.length>1)return h.info({description:"String list of groups.",list:n,func:"isInGroup",obj:"Matter"}),{v:t.isInGroups(n)};var o=t.token.data.groups||[];return h.log({description:"Checking if user is in group.",group:r,userGroups:t.token.data.groups||[],func:"isInGroup",obj:"Matter"}),{v:u.any(o,function(e){return r==e.name})}}();return"object"==typeof r?r.v:void 0}},{key:"isInGroups",value:function(e){var t=this;if(!this.isLoggedIn)return h.log({description:"No logged in user to check.",func:"isInGroups",obj:"Matter"}),!1;if(e&&u.isArray(e))return u.every(u.map(e,function(e){return u.isString(e)?t.isInGroup(e):u.has(e,"name")?t.isInGroup(e.name):(h.error({description:"Invalid group object.",group:e,func:"isInGroups",obj:"Matter"}),!1)}),!0);if(e&&u.isString(e)){var r=e.split(",");return r.length>1?this.isInGroups(r):this.isInGroup(r[0])}return h.error({description:"Invalid groups list.",func:"isInGroups",obj:"Matter"}),!1}},{key:"endpoint",get:function(){u.has(this,"options")&&(this.options.localServer&&(p.envName="local",h.info({description:"LocalServer option was set to true. Now server url is local server.",url:p.serverUrl,func:"endpoint",obj:"Matter"})),this.options.env&&(p.envName=this.options.env,h.info({description:"Environment set based on provided environment.",config:p,func:"endpoint",obj:"Matter"})));var e=p.serverUrl+"/apps/"+this.name;return"tessellate"==this.name&&("undefined"==typeof window||!u.has(window,"location")||-1===window.location.host.indexOf("tessellate")&&-1===window.location.host.indexOf("localhost")||(e=p.serverUrl,h.info({description:"Host is Tessellate Server, serverUrl simplified!",url:p.serverUrl,func:"endpoint",obj:"Matter"}))),h.log({description:"Endpoint created.",url:e,func:"endpoint",obj:"Matter"}),e}},{key:"isLoggedIn",get:function(){return this.token.string?!0:!1}},{key:"currentUser",set:function(e){h.log({description:"Current User set.",user:e,func:"currentUser",obj:"Matter"}),this.storage.setItem(p.tokenUserDataName,e)},get:function(){return this.storage.getItem(p.tokenUserDataName)?this.storage.getItem(p.tokenUserDataName):null}},{key:"storage",get:function(){return w}},{key:"token",get:function(){return b}},{key:"utils",get:function(){return{logger:h,request:j,storage:w,dom:m}}}]),e}();return P});
//# sourceMappingURL=matter.min.js.map
