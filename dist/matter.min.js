function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(r,t,o){return t&&e(r.prototype,t),o&&e(r,o),r}}();!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r(require("lodash"),require("jwt-decode"),require("superagent")):"function"==typeof define&&define.amd?define(["lodash","jwt-decode","superagent"],r):e.Matter=r(e._,e.jwtDecode,e.superagent)}(this,function(e,r,t){"use strict";function o(e,r){return e&&console[e]?console[e].apply(console,r):console.log.apply(console,r)}function n(r){var t="",o={};e.isObject(r)?("debug"==c&&e.has(r,"func")&&(t+=e.has(r,"obj")?"["+r.obj+"."+r.func+"()]\n ":e.has(r,"file")?"["+r.file+" > "+r.func+"()]\n ":"["+r.func+"()]\n "),e.each(e.omit(e.keys(r)),function(n,i,s){"func"!=n&&"obj"!=n&&("description"==n||"message"==n?t+=r[n]:e.isString(r[n])?o[n]=r[n]:o[n]=r[n])}),t+="\n"):e.isString(r)&&(t=r);var n=[t,o];return n}function i(e){var t=void 0;if(e&&""!=e)try{t=r(e)}catch(o){throw d.error({description:"Error decoding token.",data:t,error:o,func:"decodeToken",file:"token"}),new Error("Invalid token string.")}return t}function s(e){return new Promise(function(r,t){e.end(function(e,o){return e?(401==e.status&&d.warn({description:"Unauthorized. You must be signed into make this request.",func:"handleResponse"}),e&&e.response?t(e.response.text):(d.warn({description:"Unauthorized. You must be signed into make this request.",error:e,func:"handleResponse"}),t(e))):r(o.body)})})}function u(e){return g.string&&(e=e.set("Authorization","Bearer "+g.string),console.info({message:"Set auth header",func:"addAuthHeader",file:"request"})),e}e="default"in e?e["default"]:e,r="default"in r?r["default"]:r,t="default"in t?t["default"]:t;var a={serverUrl:"http://tessellate.elasticbeanstalk.com",tokenName:"tessellate",tokenDataName:"tessellate-tokenData",tokenUserDataName:"tessellate-currentUser",logLevel:"debug"},c="debug";a.logLevel&&(c=a.logLevel);var d={log:function(e){var r=n(e);"production"==a.envName?o("log",r):o("log",r)},info:function(e){var r=n(e);"production"==a.envName?o("info",r):o("info",r)},warn:function(e){var r=n(e);"production"==a.envName?o("warn",r):o("warn",r)},debug:function(e){var r=n(e);"production"==a.envName||o("debug",r)},error:function(e){var r=n(e);"production"==a.envName?o("error",r):o("error",r)}},l={loadCss:function(e){if("undefined"==typeof document)throw d.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.");var r=document.createElement("link");return r.rel="stylesheet",r.type="text/css",r.href=e,document.getElementsByTagName("head")[0].insertBefore(r,document.getElementsByTagName("head")[0].firstChild),d.log({description:"CSS was loaded into document.",element:r,func:"loadCss",obj:"dom"}),r},loadJs:function(r){if("undefined"!=typeof window&&e.has(window,"document")){var t=window.document.createElement("script");return t.src=r,t.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(t),d.log({description:"JS was loaded into document.",element:t,func:"loadCss",obj:"dom"}),t}throw d.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")},asyncLoadJs:function(r){if("undefined"!=typeof window&&e.has(window,"document")){var t=window.document.createElement("script");return t.src=r,t.type="text/javascript",window.document.getElementsByTagName("head")[0].appendChild(t),d.log({description:"JS was loaded into document.",element:t,func:"loadCss",obj:"dom"}),new Promise(function(e,r){window.setTimeout(e,30)})}throw d.error({description:"Document does not exsist to load assets into.",func:"loadCss",obj:"dom"}),new Error("Document object is required to load assets.")}},p={},f=Object.defineProperties({item:function(e,r){return this.setItem(e,r)},setItem:function(r,t){p[r]=t,this.localExists&&(e.isObject(t)&&(t=JSON.stringify(t)),window.sessionStorage.setItem(r,t))},getItem:function(e){if(p[e])return p[e];if(this.localExists){var r=window.sessionStorage.getItem(e);if(r){var t=!1,o=null;try{o=JSON.parse(r),t=!0}catch(n){t=!1}if(t)return o}return r}return null},removeItem:function(e){if(p[e]&&(p[e]=null),this.localExists)try{window.sessionStorage.removeItem(e)}catch(r){d.error({description:"Error removing item from session storage",error:r,obj:"storage",func:"removeItem"})}},clear:function(){if(p={},this.localExists)try{window.sessionStorage.clear()}catch(e){d.warn({description:"Session storage could not be cleared.",error:e})}}},{localExists:{get:function(){var e="test";if("undefined"==typeof window||"undefined"==typeof window.sessionStorage)return!1;try{return window.sessionStorage.setItem(e,"1"),window.sessionStorage.removeItem(e),!0}catch(r){return d.error({description:"Error saving to session storage",error:r,obj:"storage",func:"localExists"}),!1}},configurable:!0,enumerable:!0}}),g=Object.defineProperties({save:function(e){this.string=e},"delete":function(){f.removeItem(a.tokenName),f.removeItem(a.tokenDataName),d.log({description:"Token was removed.",func:"delete",obj:"token"})}},{string:{get:function(){return f.getItem(a.tokenName)},set:function(t){var o=void 0;if(e.isString(t))o=t;else{if(d.log({description:"Token data is not string.",token:t,func:"string",obj:"token"}),!e.isObject(t)||!e.has(t,"token"))return void d.error({description:"Invalid value set to token.",token:t,func:"string",obj:"token"});o=t.token}d.log({description:"Token was set.",token:t,tokenStr:o,func:"string",obj:"token"}),f.setItem(a.tokenName,o),this.data=r(o)},configurable:!0,enumerable:!0},data:{get:function(){return f.getItem(a.tokenDataName)?f.getItem(a.tokenDataName):i(this.string)},set:function(r){if(e.isString(r)){var t=r;r=i(t),d.info({description:"Token data was set as string. Decoding token.",token:t,tokenData:r,func:"data",obj:"token"})}else d.log({description:"Token data was set.",data:r,func:"data",obj:"token"}),f.setItem(a.tokenDataName,r)},configurable:!0,enumerable:!0}}),h={get:function(e,r){var o=t.get(e);return r&&o.query(r),o=u(o),s(o)},post:function(e,r){var o=t.post(e).send(r);return o=u(o),s(o)},put:function(e,r){var o=t.put(e,r);return o=u(o),s(o)},del:function(e,r){var o=t.put(e,r);return o=u(o),s(o)}},m={},v=function(){function e(r){_classCallCheck(this,e),this.app=r.app?r.app:null,this.redirectUri=r.redirectUri?r.redirectUri:"redirect.html",this.provider=r.provider?r.provider:null}return _createClass(e,[{key:"loadHello",value:function(){return"undefined"==typeof window||window.hello?Promise.reject():l.asyncLoadJs("https://s3.amazonaws.com/kyper-cdn/js/hello.js")}},{key:"helloLoginListener",value:function(){window.hello.on("auth.login",function(e){d.info({description:"User logged in to google.",func:"loadHello",obj:"Google"}),window.hello(e.network).api("/me").then(function(r){var t=r;return t.provider=e.network,h.post(this.endpoint+"/provider",t).then(function(e){return d.log({description:"Provider request successful.",response:e,func:"signup",obj:"GoogleUtil"}),e})["catch"](function(e){return d.error({description:"Error requesting login.",error:e,func:"signup",obj:"Matter"}),Promise.reject(e)})})})}},{key:"initHello",value:function(){var e=this;return this.loadHello().then(function(){return h.get(e.app.endpoint+"/providers").then(function(r){d.log({description:"Provider request successful.",response:r,func:"initHello",obj:"ProviderAuth"});var t=r[e.provider];return t?(d.log({description:"Providers config built",providersConfig:r,func:"initHello",obj:"ProviderAuth"}),window.hello.init(r,{redirect_uri:"redirect.html"})):(d.error({description:"Provider is not setup. Visit tessellate.kyper.io to enter your client id for "+e.provider,provider:e.provider,clientIds:m,func:"login",obj:"ProviderAuth"}),Promise.reject({message:"Provider is not setup."}))},function(e){return d.error({description:"Error loading hellojs.",error:errRes,func:"initHello",obj:"ProviderAuth"}),Promise.reject({message:"Error requesting application third party providers."})})["catch"](function(e){return d.error({description:"Error loading hellojs.",error:e,func:"initHello",obj:"ProviderAuth"}),Promise.reject({message:"Error loading third party login capability."})})})}},{key:"login",value:function(){var e=this;return this.initHello().then(function(){return window.hello.login(e.provider)},function(e){return d.error({description:"Error initalizing hellojs.",error:e,func:"login",obj:"Matter"}),Promise.reject({message:"Error with third party login."})})}},{key:"signup",value:function(){return this.login()}}]),e}(),w=function(){function r(e,t){if(_classCallCheck(this,r),!e)throw d.error({description:"Application name requires to use Matter.",func:"constructor",obj:"Matter"}),new Error("Application name is required to use Matter");this.name=e,t&&(this.options=t)}return _createClass(r,[{key:"signup",value:function(r){if(d.log({description:"Signup called.",signupData:r,func:"signup",obj:"Matter"}),!r||!e.isObject(r)&&!e.isString(r))return d.error({description:"Signup information is required to signup.",func:"signup",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(e.isObject(r))return h.post(this.endpoint+"/signup",r).then(function(t){return d.log({description:"Account request successful.",signupData:r,response:t,func:"signup",obj:"Matter"}),e.has(t,"account")?t.account:(d.warn({description:"Account was not contained in signup response.",signupData:r,response:t,func:"signup",obj:"Matter"}),t)})["catch"](function(e){return d.error({description:"Error requesting signup.",signupData:r,error:e,func:"signup",obj:"Matter"}),Promise.reject(e)});var t=new v({provider:r,app:this});return t.signup(r).then(function(e){return d.info({description:"Provider signup successful.",provider:r,res:e,func:"signup",obj:"Matter"}),Promise.resolve(e)})}},{key:"login",value:function(r){var t=this;if(!r||!e.isObject(r)&&!e.isString(r))return d.error({description:"Username/Email and Password are required to login",func:"login",obj:"Matter"}),Promise.reject({message:"Login data is required to login."});if(e.isObject(r))return r.password&&r.username?h.put(this.endpoint+"/login",r).then(function(r){return e.has(r,"data")&&e.has(r.data,"status")&&409==r.data.status?(d.warn({description:"Account not found.",response:r,func:"login",obj:"Matter"}),Promise.reject(r.data)):(d.log({description:"Successful login.",response:r,func:"login",obj:"Matter"}),e.has(r,"token")&&(t.token.string=r.token),e.has(r,"account")&&t.storage.setItem(a.tokenUserDataName,r.account),r.account)})["catch"](function(e){return d.error({description:"Error requesting login.",error:e,status:e.status,func:"login",obj:"Matter"}),(409==e.status||400==e.status)&&(e=e.response.text),Promise.reject(e)}):Promise.reject({message:"Username/Email and Password are required to login"});var o=new v({provider:r,app:this});return o.login().then(function(e){return d.info({description:"Provider login successful.",provider:r,res:e,func:"login",obj:"Matter"}),Promise.resolve(e)})}},{key:"logout",value:function(){var e=this;return this.isLoggedIn?h.put(this.endpoint+"/logout").then(function(r){return d.log({description:"Logout successful.",response:r,func:"logout",obj:"Matter"}),e.currentUser=null,e.token["delete"](),r})["catch"](function(r){return d.error({description:"Error requesting log out: ",error:r,func:"logout",obj:"Matter"}),e.storage.removeItem(a.tokenUserDataName),e.token["delete"](),Promise.reject(r)}):(d.warn({description:"No logged in account to log out.",func:"logout",obj:"Matter"}),Promise.reject({message:"No logged in account to log out."}))}},{key:"getCurrentUser",value:function(){var e=this;return this.currentUser?Promise.resolve(this.currentUser):this.isLoggedIn?h.get(this.endpoint+"/user").then(function(r){return d.log({description:"Current User Request responded.",responseData:r,func:"currentUser",obj:"Matter"}),e.currentUser=r,r})["catch"](function(e){return 401==e.status?(d.warn({description:"Called for current user without token.",error:e,func:"currentUser",obj:"Matter"}),g["delete"](),Promise.resolve(null)):(d.error({description:"Error requesting current user.",error:e,func:"currentUser",obj:"Matter"}),Promise.reject(e))}):Promise.resolve(null)}},{key:"updateProfile",value:function(e){var r=this;return this.isLoggedIn?h.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return d.log({description:"Update profile request responded.",responseData:e,func:"updateProfile",obj:"Matter"}),r.currentUser=e,e})["catch"](function(e){return d.error({description:"Error requesting current user.",error:e,func:"updateProfile",obj:"Matter"}),Promise.reject(e)}):(d.error({description:"No current user profile to update.",func:"updateProfile",obj:"Matter"}),Promise.reject({message:"Must be logged in to update profile."}))}},{key:"changePassword",value:function(e){return this.isLoggedIn?h.put(this.endpoint+"/user/"+this.token.data.username,e).then(function(e){return d.log({description:"Update password request responded.",responseData:e,func:"changePassword",obj:"Matter"}),e})["catch"](function(e){return d.error({description:"Error requesting password change.",error:e,func:"changePassword",obj:"Matter"}),Promise.reject(e)}):(d.error({description:"No current user profile for which to change password.",func:"changePassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to change password."}))}},{key:"recoverPassword",value:function(){return this.isLoggedIn?h.post(this.endpoint+"/accounts/"+this.token.data.username+"/recover").then(function(e){return d.log({description:"Recover password request responded.",responseData:e,func:"recoverPassword",obj:"Matter"}),e})["catch"](function(e){return d.error({description:"Error requesting password recovery.",error:e,func:"recoverPassword",obj:"Matter"}),Promise.reject(e)}):(d.error({description:"No current user for which to recover password.",func:"recoverPassword",obj:"Matter"}),Promise.reject({message:"Must be logged in to recover password."}))}},{key:"isInGroup",value:function(r){var t=this;if(!this.isLoggedIn)return d.log({description:"No logged in user to check.",func:"isInGroup",obj:"Matter"}),!1;if(!r||!e.isString(r))return r&&e.isArray(r)?(d.info({description:"Array of groups.",list:r,func:"isInGroup",obj:"Matter"}),this.isInGroups(r)):!1;var o=function(){var o=r,n=o.split(",");if(n.length>1)return d.info({description:"String list of groups.",list:n,func:"isInGroup",obj:"Matter"}),{v:t.isInGroups(n)};var i=t.token.data.groups||[];return d.log({description:"Checking if user is in group.",group:o,userGroups:t.token.data.groups||[],func:"isInGroup",obj:"Matter"}),{v:e.any(i,function(e){return o==e.name})}}();return"object"==typeof o?o.v:void 0}},{key:"isInGroups",value:function(r){var t=this;if(!this.isLoggedIn)return d.log({description:"No logged in user to check.",func:"isInGroups",obj:"Matter"}),!1;if(r&&e.isArray(r))return e.every(e.map(r,function(r){return e.isString(r)?t.isInGroup(r):e.has(r,"name")?t.isInGroup(r.name):(d.error({description:"Invalid group object.",group:r,func:"isInGroups",obj:"Matter"}),!1)}),!0);if(r&&e.isString(r)){var o=r.split(",");return o.length>1?this.isInGroups(o):this.isInGroup(o[0])}return d.error({description:"Invalid groups list.",func:"isInGroups",obj:"Matter"}),!1}},{key:"endpoint",get:function(){var r=a.serverUrl;return e.has(this,"options")&&this.options.localServer&&(r="http://localhost:4000",d.info({description:"LocalServer option was set to true. Now server url is local server.",url:r,func:"endpoint",obj:"Matter"})),"tessellate"==this.name?"undefined"!=typeof window&&e.has(window,"location")&&-1!==window.location.host.indexOf("tessellate")&&(r="",d.info({description:"Host is Tessellate Server, serverUrl simplified!",url:r,func:"endpoint",obj:"Matter"})):(r=r+"/apps/"+this.name,d.log({description:"Server url set.",url:r,func:"endpoint",obj:"Matter"})),r}},{key:"currentUser",set:function(e){d.log({description:"Current User set.",user:e,func:"currentUser",obj:"Matter"}),this.storage.setItem(a.tokenUserDataName,e)},get:function(){return this.storage.getItem(a.tokenUserDataName)?this.storage.getItem(a.tokenUserDataName):null}},{key:"storage",get:function(){return f}},{key:"token",get:function(){return g}},{key:"utils",get:function(){return{logger:d,request:h,storage:f,dom:l}}},{key:"isLoggedIn",get:function(){return this.token.string?!0:!1}}]),r}();return w});
//# sourceMappingURL=matter.min.js.map
